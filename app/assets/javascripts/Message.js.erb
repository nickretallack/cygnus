Message = (function(){

  var Message = function(element){

    var self = this;

    self.message = element;
    self.imageArea = self.message.find(".image").parent();
    self.author = self.message.find("h5").text();
    self.content = self.message.find("blockquote");
    self.buttonArea = element.find(".button-area");
    self.buttonIcons = JSON.parse('<%= CONFIG[:message_icons].to_json %>');

  };

  Make.extend(Message.prototype, {

    initialize: function(){
      var self = this;
      self.buttonArea.html("");
      $.each(self.buttonIcons, function(name, icon){
        self.buttonArea.append(self.makeButton(name, icon).one("click.Message", function(){
          if(typeof self[name.camelCase()] === "function") self[name.camelCase()]($(this));
        }));
      });
    },

    makeButton: function(name, icon){
      var button = $("<i />", {
                    class: "material-icons medium-small",
                    text: icon,
                    title: name.readable()
                  }),
            label = $("<label />", {
                      text: name.readable(),
                      css: {
                        display: "block"
                      }
                    }),
            div = $("<div />", {
                    css: {
                      float: "left",
                      width: "100px"
                    }
                  });
        div.append(button, label);
        return div;
    },

    indentOf: function(message){
      var self = this;
      return (parseInt(/indent-(\d+)/.exec(message.attr("class"))[1]));
    },

    reply: function(div){
      var self = this,
          button = div.children("i");
      if(self.message.next().is(".new")) return;
      button.replaceWithSpinner();
      if(/submission\/(\d+)/.test(window.location.pathname)){
        $.ajax({
          url: "/reply",
          data: {
            submission: RegExp.$1,
            reply: self.message.attr("id"),
            indent: /indent-(\d+)/.exec(self.message.attr("class"))[1]
          },
          success: function(data){
            self.message.after(data);
            initialize();
          }
        });
      }
    },

    minimizeConversation: function(div){
      var self = this,
          conversation = self.message.nextUntil(self.message.nextAll().filter(function(index, element){
            return self.indentOf($(element)) <= self.indentOf(self.message);
          })),
          extraneousElements = self.imageArea.add(self.content).add(self.buttonArea.children());
      extraneousElements.hide();
      conversation.hide();
      div.replaceWith(self.makeButton("maximize_conversation", '<%= CONFIG[:other_icons][:maximize] %>').one("click.Message", function(){
        $(this).replaceWith(div);
        extraneousElements.show();
        conversation.show();
        self.initialize();
      }));
    },

    quote: function(div){
      var self = this,
          button = div.children("i");
      if(!self.message.next().is(".new")){
        button.replaceWithSpinner();
        if(/submission\/(\d+)/.test(window.location.pathname)){
          $.ajax({
            url: "/reply",
            data: {
              submission: RegExp.$1,
              reply: self.message.attr("id"),
              indent: /indent-(\d+)/.exec(self.message.attr("class"))[1]
            },
            success: function(data){
              data = $(data);
              var textarea = data.find("textarea");
              textarea.prop("value", ">" + self.content.text());
              textarea.putCursorAtEnd();
              self.message.after(data);
              initialize();
            }
          });
        }
      }
    },

    pmAuthor: function(div){
      var self = this;
      window.open("/" + $("#current-user").text() + "/conversations/reply/" + self.author, "_blank");
    }

  })

  return Message;

})();