Message = (function(){

  var Message = function(element){

    var self = this;

    self.message = element;
    self.buttonArea = element.find(".button-area");
    self.buttonIcons = JSON.parse('<%= CONFIG[:message_icons].to_json %>');
    self.replyArea = element.nextAll(".reply-area").eq(0);

  }

  Make.extend(Message.prototype, {

    initialize: function(){
      var self = this;
      $.each(self.buttonIcons, function(name, icon){
        var button = $("<i />", {
                    class: "material-icons medium-small",
                    text: icon,
                    title: name.readable()
                  }),
            label = $("<label />", {
                      text: name.readable(),
                      css: {
                        display: "block"
                      }
                    }),
            div = $("<div />", {
                    css: {
                      float: "left",
                      width: "100px"
                    }
                  });
        div.append(button, label);
        self.buttonArea.append(div);
        button.one("click.Message", function(){
          if(typeof self[name.camelCase()] === "function") self[name.camelCase()](button);
        });
      });
    },

    reply: function(button){
      var self = this;
      if(/submission\/(\d+)/.test(window.location.pathname) && self.replyArea.is(":empty")){
        button.replaceWithSpinner();
        $.ajax({
          url: "/reply",
          data: {
            submission: RegExp.$1,
            reply: self.message.attr("id"),
            indent: /indent-(\d+)/.exec(self.message.attr("class"))[1]
          },
          success: function(data){
            self.replyArea.html(data);
            initialize();
          }
        })
      }
    }

  })

  return Message;

})();