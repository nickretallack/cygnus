OrderForm = (function(){

  var OrderForm = function(element){

    var self = this;

    self.div = element;
    self.form = $("#"+self.div.attr("form"));
    self.submit = self.form.children("[type = submit]");
    self.contentField = self.form.children("[name = 'order_form[content]']");
    self.workspace = element.find("#workspace");
    self.buttonArea = self.div.find("#button-area");
    self.icons = JSON.parse('<%= CONFIG[:order_form_icons].to_json %>');
    self.buttons = {};
    self.templates = {};

    $.each(self.icons, function(name, icon){
      self.buttons[name.camelCase()] = $("<button />", {
        class: "btn button-with-icon no-effects",
        text: name.readable()
      }).prepend($("<i />", {
        class: "material-icons",
        text: icon
      }));
      self.templates[name.camelCase()] = $($("#" + name + "-template").html());
    });

    $.each(self.buttons, function(key, value){
      self.buttonArea.append(value);
      value.on("click.OrderForm", function(){
        self.add(key);
      });
    });

  };

  Make.extend(OrderForm.prototype, {

    initialize: function(){
      var self = this;
      self.workspace.children(".question").children("i").off("click.Orderform").on("click.OrderForm", function(){
        self.remove($(this).parent());
      });
      self.form.children(".question").remove();
      self.submit.one("click.OrderForm", function(event){
        pause(event);
        self.generateContentFieldValue();
        $(this).trigger("click");
      });
    },

    add: function(name){
      var self = this, question;
      self.workspace.append((question = self.templates[name].clone()));
      question.children("i").on("click.OrderForm", function(){
        self.remove(question);
      });
    },

    remove: function(target){
      var self = this;
      target.remove();
    },

    generateContentFieldValue: function(){
      var self = this,
          array = [];
      $.each(self.workspace.children(".question").toArray().map(function(element){
        element = $(element);
        var object = {};
        object[element.attr("name")] = element.children(".content").html();
        return object;
      }), function(index, element){
        self.form.append($("<input />", {
          class: "question",
          type: "hidden",
          name: "order_form[content]["+self.form.children(".question").length+"]",
          value: JSON.stringify(element)
        }));
      });
    }

  });

  return OrderForm;

})();