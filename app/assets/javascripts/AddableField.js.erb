AddableField = (function(){

  var AddableField = function(element){

    var self = this;

    self.field = element;
    self.area = element.siblings(".addable-area");
    self.addable = self.field.children().last();
    self.orderable = self.field.is(".orderable");
    self.button = $("<i />", {
      class: "material-icons medium-small",
      text: "<%= CONFIG[:button_icons][:add] %>",
    });

    self.button.on("click.AddableField", function(){
      self.add();
    });

    if(self.orderable && self.addable.is("li")){
      self.field.children("li").each(function(index, li){
        self.initializeHandle($(li));
      });
    }

    self.area.append(self.button);

  };

  Make.extend(AddableField.prototype, {

    initialize(){
      var self = this;
      console.log("here");
      self.area.css({
        height: self.field.outerHeight()
      });
    },

    initializeHandle: function(li){
      var self = this;
      li.children(".handle").on("mousedown.AddableField", function(){
        self.reorder(li);
      });
    },

    add: function(){
      var self = this,
          addable = self.addable.clone(),
          field = addable.find("textarea, input, select").prop("value", "");

      if(field.is("select")){
        field.children("option").removeAttr("selected");
      }
      var nameArray = field.attr("name").toArray();
      nameArray[nameArray.length - 1] = parseInt(nameArray.last()) + 1;
      var name = nameArray.parse();
      field.attr("name", name);
      field.attr("id", name);
      self.addable = addable;
      self.field.append(addable);
      self.area.css({
        height: self.field.outerHeight()
      });
      if(addable.is("li")){
        self.initializeHandle(addable);
      }
    },

    reorder: function(li){
      var self = this,
          ol = li.closest("ol");
      ol.find("*").addClass("no-select");
      ol.one("mousemove.AddableField", function(){
        ol.children().on("mouseenter.AddableField", function(event){
          var target = $(event.target);
          target = target.is("li")? target : target.closest("li");
          if(target.index() < li.index()){
            li.insertBefore(target);
          }else if(target.index() > li.index()){
            li.insertAfter(target);
          }
        });
      });
      $(window).one("mouseup.AddableField", function(event){
        ol.find("*").removeClass("no-select");
        ol.off("mousemove.AddableField");
        ol.children().off("mouseenter.AddableField");
      });
    }

  });

  return AddableField;

})();