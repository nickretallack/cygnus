AddableField = (function(){

  var AddableField = function(element){

    var self = this;

    self.field = element;
    self.area = element.siblings(".addable-area");
    self.addable = self.field.children().last();
    self.orderable = self.field.is(".orderable");
    self.addButton = $("<i />", {
      class: "material-icons medium-small add",
      text: "<%= CONFIG[:button_icons][:add] %>",
      css: {
        height: self.addable.outerHeight()
      }
    });
    self.removeButton = $("<i />", {
      class: "material-icons medium-small",
      text: "<%= CONFIG[:button_icons][:remove] %>"
    });

    self.addButton.on("click.AddableField", function(){
      self.add();
    });

    if(self.orderable && self.addable.is("li")){
      self.field.children("li").each(function(index, li){
        self.initializeHandle($(li));
      });
    }

    self.area.append(self.addButton);

    self.field.children().each(function(index, item){
      self.initializeRemove($(item));
    });

  };

  Make.extend(AddableField.prototype, {

    initialize(){
      var self = this,
          children = self.field.children();
      if(self.addable.is("li")){
        self.initializeHandle(children.last());
      }
    },

    initializeHandle: function(li){
      var self = this;
      li.children(".handle").off("mousedown.AddableField").on("mousedown.AddableField", function(){
        self.reorder(li);
      });
    },

    initializeRemove: function(item){
      var self = this,
          children = self.field.children();
      self.addButton.before(self.removeButton.clone().css({
        height: self.addable.outerHeight()
      }).on("click.AddableField", function(){
        self.remove(item);
      }));
    },

    add: function(){
      var self = this,
          addable = self.addable.clone(),
          field = addable.find("textarea, input, select").prop("value", "");

      if(field.is("select")){
        field.children("option").removeAttr("selected");
      }
      var nameArray = field.attr("name").toArray();
      nameArray[nameArray.length - 1] = parseInt(nameArray.last()) + 1;
      var name = nameArray.parse();
      field.attr("name", name);
      field.attr("id", name);
      self.addable = addable;
      self.field.append(addable);
      self.initialize();
      self.initializeRemove(addable);
    },

    remove: function(item){
      var self = this,
          buttons = self.area.children(":not(.add)");
      buttons.eq(item.index()).remove();
      item.remove();
    },

    reorder: function(li){
      var self = this,
          ol = li.closest("ol");
      ol.find("*").addClass("no-select");
      ol.one("mousemove.AddableField", function(){
        ol.children().on("mouseenter.AddableField", function(event){
          var target = $(event.target),
              buttons = self.area.children(":not(.add)");
          target = target.is("li")? target : target.closest("li");
          if(target.index() < li.index()){
            buttons.eq(li.index()).insertBefore(buttons.eq(target.index()))
            li.insertBefore(target);
          }else if(target.index() > li.index()){
            buttons.eq(li.index()).insertAfter(buttons.eq(target.index()))
            li.insertAfter(target);
          }
        });
      });
      $(window).one("mouseup.AddableField", function(event){
        ol.find("*").removeClass("no-select");
        ol.off("mousemove.AddableField");
        ol.children().off("mouseenter.AddableField");
      });
    }

  });

  return AddableField;

})();