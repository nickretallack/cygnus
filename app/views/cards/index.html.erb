<% provide :header, link_to(@user.name, user_path(@user))+"'s workboard" %>

<% if can_modify? @user %>
  <div class = "row hc js">
    <span>
      <%= link_to "View Mode", "", remote: true, class: "trigger" %>
      <div class = "vdiv"></div>
      <%= link_to "Edit Mode", "", remote: true, class: "trigger" %>
      <div class = "vdiv"></div>
      <%= link_to "Reorder Mode", "", remote: true, class: "trigger" %>
    </span>
  </div>
<% end %>
<div class = "row">
  <div class = "card top-card" id = "'<%= @top_card.id %>'">
    <div class = "card-content">
      <div class = "card-title">
        <% if can_modify? @user %>
          <%= form_for @top_card, url: card_path(@user, @top_card), method: :patch do |f| %>
            <%= f.hidden_field :order, value: cards_order %>
            <div class = "js reorder-mode">
              <%= f.submit "Finalize Order" %>
            </div>
          <% end %>
          <div class = "new edit-mode">
            <%= form_for @top_card, url: card_path(@user, @top_card), method: :patch do |f| %>
              <%= f.text_field :title, placeholder: "Title for New List" %>
              <%= f.submit "Create List" %>
            <% end %>
          </div>
        <% end %>
        <p>
          <% @top_card.cards.collect { |card_id| Card.find(card_id) }.each do |list| %>
            <div class = "card list" id = "'<%= list.id %>'" >
              <div class = "card-content">
                <div class = "card-title">
                  <div class = "hc view-mode reorder-mode">
                    <h4 id = "title"><%= title_for list: list %></h4>
                    <hr />
                  </div>
                  <% if can_modify? @user %>
                    <div class = "edit-mode">
                      <%= form_for list, url: card_path(@user, list), method: :patch do |f| %>
                        <%= f.text_field :title, placeholder: "List Title" %>
                        <%= f.submit "Save List" %>
                      <% end %>
                      <%= button_to "Delete List", card_path(@user, list), method: :delete %>
                    </div>
                    <div class = "new edit-mode">
                      <%= form_for list, url: card_path(@user, list), method: :patch do |f| %>
                        <%= f.text_field :title, placeholder: "Title for New Card", value: "" %>
                        <%= f.submit "Create Card" %>
                      <% end %>
                    </div>
                  <% end %>
                  <% list.cards.collect { |card_id| Card.find(card_id) }.each do |card| %>
                    <div class = "card" id = "'<%= card.id %>'">
                      <div class = "card-content">
                        <div class = "card-title">
                          <div class = "hc view-mode reorder-mode">
                            <h5 id = "title"><%= title_for workcard: card %></h5>
                            <hr />
                          </div>
                          <% if can_modify? @user %>
                            <div class = "edit-mode">
                              <%= form_for card, url: card_path(@user, card), method: :patch do |f| %>
                                <%= f.text_field :title, placeholder: "Card Title" %>
                                <%= f.text_area :description, placeholder: "Description" %>
                                <div class = "new">
                                  <%= f.fields_for card.file_id.nil?? Upload.new : Upload.find(card.file_id), multipart: true do |u| %>
                                    <div class = "input-field"><%= u.check_box :explicit %><%= u.label :explicit, "Explicit Attachment" %></div>
                                    <div class = "row file-field input-field">
                                      <div class = "submit">
                                        <span>Attachment</span>
                                        <%= u.file_field :picture %>
                                      </div>
                                    </div>
                                  <% end %>
                                  <div class = "js thumb-preview">
                                    <%= cell(:image).(:show, type: :bordered, id: card.file_id) if card.file_id %>
                                  </div>
                                </div>
                                <%= f.submit "Save Card" %>
                              <% end %>
                              <%= button_to "Delete Card", card_path(@user, card), method: :delete %>
                            </div>
                          <% end %>
                          <div class = "card-action">
                            <div class = "view-mode">
                              <%= cell(:image).(:show, type: :bordered, id: card.file_id) if card.file_id %>
                              <span><%= message_for description: card.description %></span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </p>
      </div>
    </div>
  </div>
</div>